<!doctype html>
<html lang="ru">
<head>
  <link rel="icon" href="favicon_io/favicon.ico" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GO-WEB-CHAT</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --accent: #2563eb;
      --accent-2: #60a5fa;
      --danger: #ef4444;
      --ring: rgba(96,165,250,.45);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 10% 10%, rgba(96,165,250,.12), transparent 60%),
                  radial-gradient(1000px 600px at 90% 20%, rgba(34,197,94,.08), transparent 55%),
                  var(--bg);
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .card {
      width: 100%;
      max-width: 640px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      backdrop-filter: blur(8px);
      border: 1px solid rgba(148,163,184,.2);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding: 28px;
    }
    h1 {
      margin: 0 0 18px 0;
      font-weight: 700;
      letter-spacing: .2px;
      font-size: 24px;
    }
    .input {
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(17,24,39,.6);
      color: var(--text);
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .input::placeholder { color: #9ca3af; }
    .input:focus { border-color: var(--accent-2); box-shadow: 0 0 0 4px var(--ring); }

    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      font-weight: 600; letter-spacing: .2px;
      border-radius: 12px; border: 1px solid rgba(37,99,235,.6);
      background: linear-gradient(180deg, var(--accent), #1d4ed8);
      color: white; cursor: pointer;
      transition: transform .06s ease, filter .15s ease, box-shadow .15s ease;
      box-shadow: 0 8px 20px rgba(37,99,235,.35);
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }

    .btn-search { background: linear-gradient(180deg, #16a34a, #15803d); border-color: #16a34a; box-shadow: 0 8px 20px rgba(22,163,74,.35); }
    .btn-logout { background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color: #2563eb; box-shadow: 0 8px 20px rgba(37,99,235,.35); }
    .btn-delete { background: linear-gradient(180deg, #dc2626, #b91c1c); border-color: #dc2626; box-shadow: 0 8px 20px rgba(220,38,38,.35); }

    ul { list-style: none; padding: 0; margin: 0; }
    li {
      background: rgba(17,24,39,.6);
      padding: 10px;
      margin: 6px 0;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,.25);
      color: var(--text);
    }

    .actions { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; }
  </style>
</head>
<body>
  <main class="card">
    <h1>GO-WEB-CHAT</h1>

    <!-- –ü–æ–∏—Å–∫ -->
    <div v-if="!selectedUser">
      <input v-model="query" class="input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç" />
      <button class="btn btn-search" @click="fetchAccounts">–ù–∞–π—Ç–∏</button>

      <div v-if="users.length">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</h3>
        <ul>
          <li v-for="(user, index) in users" :key="index" @click="openChat(user)" style="cursor:pointer">
            {{ user.name }} ‚Äî {{ user.email }}
          </li>
        </ul>
      </div>
    </div>

    <!-- –ß–∞—Ç -->
    <div v-else>
      <h3>–ß–∞—Ç —Å {{ selectedUser.name }}</h3>
      <ul>
        <li v-for="(msg, index) in messages" :key="index">
          <b>{{ msg.sender === myUsername ? "–í—ã" : msg.sender }}:</b> {{ msg.text }}
        </li>
      </ul>

      <input v-model="newMessage" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." @keyup.enter="sendMessage" />
      <button class="btn" @click="sendMessage">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="btn btn-delete" @click="closeChat">–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç</button>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
    <div class="actions" v-if="!selectedUser">
      <button class="btn btn-logout" @click="logout">–í—ã–π—Ç–∏</button>
      <button class="btn btn-delete" @click="deleteAccount">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
new Vue({
  el: 'main',
  data: {
    query: '',
    users: [],
    selectedUser: null,
    messages: [],
    newMessage: '',
    ws: null,
    myUsername: null
  },
  async mounted() {
    // —É–∑–Ω–∞—ë–º –∏–º—è —Ç–µ–∫—É—â–µ–≥–æ —é–∑–µ—Ä–∞
    try {
      const res = await axios.get("/api/me");
      this.myUsername = res.data.username;
    } catch (e) {
      console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–º—è —é–∑–µ—Ä–∞:", e);
    }
  },
  methods: {
    async fetchAccounts() {
      try {
        const response = await axios.get(`/api/accounts`, {
          params: { search: this.query }
        });
        this.users = response.data;
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
      }
    },
async openChat(user) {
  this.selectedUser = user;
  this.messages = [];

  try {
    // üëâ –ø–æ–ª—É—á–∞–µ–º chat_id –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
    const chatRes = await axios.get("/api/chat-id", {
      params: { username: user.name }
    });
    const chatId = chatRes.data.chat_id;
    this.selectedUser.chat_id = chatId; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä—è–º–æ –≤ –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    // üëâ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
    const res = await axios.get("/api/messages", {
      params: { chat_id: chatId, limit: 50 }
    });
    this.messages = res.data;
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞:", err);
  }

  // üëâ –ø–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
  this.ws = new WebSocket(`ws://91.149.255.224:8080/ws`);

  this.ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);

    // —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
    if (msg.chat_id === this.selectedUser.chat_id) {
      this.messages.push(msg);
    }
  };

  this.ws.onopen = () => {
    console.log("WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
  };

  this.ws.onclose = () => {
    console.log("WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
  };
},
sendMessage() {
  if (!this.newMessage.trim()) return;
  const msg = {
    chat_id: this.selectedUser.chat_id,
    text: this.newMessage
  };
  this.ws.send(JSON.stringify(msg));

  // —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
  // this.messages.push({
  //   chat_id: this.selectedUser.chat_id,
  //   sender: this.myUsername,
  //   text: this.newMessage
  // });

  this.newMessage = '';
},
    closeChat() {
      if (this.ws) this.ws.close();
      this.selectedUser = null;
      this.messages = [];
    },
    async logout() {
      try {
        await axios.post('/api/logout');
        alert("–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞");
        window.location.href = "/login";
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", error);
      }
    },
    async deleteAccount() {
      if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?")) return;
      try {
        await axios.delete('/api/delete-account');
        alert("–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω");
        window.location.href = "/login";
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", error);
      }
    }
  }
});
</script>
</body>
</html>
